<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>ADX排序第二期线性回归模型排序策略 | I See Fire</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ADX排序第二期线性回归模型排序策略</h1><a id="logo" href="/.">I See Fire</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> 首頁</i></a><a href="/archives/"><i class="icon-archive"> 所有文章</i></a><a href="/about/"><i class="icon-about"> 關於</i></a><a href="/atom.xml"><i class="icon-rss"> 訂閱</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">ADX排序第二期线性回归模型排序策略</h1><div class="post-meta">2016-03-28 | <span class="categories">分類於<a href="/categories/ADX排序/"> ADX排序</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目錄</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#u80CC_u666F"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u7B97_u6CD5_u8BBE_u8BA1"><span class="toc-number">2.</span> <span class="toc-text">算法设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#u7279_u5F81_u9009_u62E9"><span class="toc-number">2.1.</span> <span class="toc-text">特征选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u7279_u5F81_u8F6C_u6362"><span class="toc-number">2.2.</span> <span class="toc-text">特征转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u6A21_u578B_u62DF_u5408"><span class="toc-number">2.3.</span> <span class="toc-text">模型拟合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u6A21_u578B_u8BC4_u4F30"><span class="toc-number">2.4.</span> <span class="toc-text">模型评估</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u7CFB_u7EDF_u5B9E_u73B0"><span class="toc-number">2.5.</span> <span class="toc-text">系统实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u6A21_u578B_u5BF9_u4E8ECTR_u7684_u63D0_u5347"><span class="toc-number">3.</span> <span class="toc-text">模型对于CTR的提升</span></a></li></ol></div></div><div class="post-content"><h2 id="u80CC_u666F"><a href="#u80CC_u666F" class="headerlink" title="背景"></a>背景</h2><p>考虑距离因素和历史CTR的排序策略在线上运行一段时间，平均ctr为0.3%。为了提高ctr，并更加精准的实现广告投放，需要挖掘数据背后的意义。同时第一期的打分策略积累了大量的曝光点击数据，可以进行线下分析，并逐渐转化为模型为主的打分策略。</p>
<h2 id="u7B97_u6CD5_u8BBE_u8BA1"><a href="#u7B97_u6CD5_u8BBE_u8BA1" class="headerlink" title="算法设计"></a>算法设计</h2><p>线性回归模型排序策略通过逻辑回归的算法来实现对广告商户的ctr进行预估的。点击率的预估主要分为以下流程：特征选择，特征转换，拟合模型，模型评估，系统实现</p>
<h3 id="u7279_u5F81_u9009_u62E9"><a href="#u7279_u5F81_u9009_u62E9" class="headerlink" title="特征选择"></a>特征选择</h3><p>特征选择分别从广告维度，用户维度，请求维度和组合特征进行选择。广告维度特征包括：广告商户的星级，一级类目，二级类目，城市，地区，商圈和平均价格等；用户维度包括：是否是点评用户，用户偏好二级类目，用户偏好地区和用户偏好行政区等；请求维度指的的流量的特征，包括：请求的经纬度，请求媒体id，请求的媒体类目等；组合特征包括：请求媒体与广告二级类目组合和请求媒体类目与广告二级类目组合等。线下训练共选取21维特征，详细如下：<br><img src="http://7xqb0e.com1.z0.glb.clouddn.com/sample_feature.png" alt=""></p>
<h3 id="u7279_u5F81_u8F6C_u6362"><a href="#u7279_u5F81_u8F6C_u6362" class="headerlink" title="特征转换"></a>特征转换</h3><p>特征转换<br>特征转换主要包括数据清洗，特征获取和计算和离散化。<br>数据清洗的工作主要是请求数据的合法判断，缺失值的处理。如果一条请求数据的曝光次数是小于点击的次数，那么该条数据就属于不合法的，理应舍弃。还有某个值出现的次数特别少（阈值可配)，如果将这些罕见的值加入训练数据，可能会造成模型的过拟合，为此将其置为null。至于缺失值的处理，目前有很多种方式，比如平均值和默认值等，在模型中我们将缺失值置为字符串”null”，出于这样的考虑是因为将缺失值”null”作为一个特征。特征获取和计算主要是连续值特征的计算，比如由请求经纬度和广告商户计算两者之间的距离，从UA数据中解析请求的平台，通过点评id来获取用户画像数据等。<br>特征可以分为两大类，类别型特征和数值型特征。对于类别型特征，直接平铺开来，而数值型特征根据该特征的不同含义作相应的处理，比如距离离散化，通过线下数据分析各个距离段的点击率差异，来进行划分。目前支持决策树的<br>方式来进行连续值的自动划分，这部分工作和特征的发掘将是以后模型优化的重点。<br><img src="http://7xqb0e.com1.z0.glb.clouddn.com/adx2_1.png" alt=""></p>
<h3 id="u6A21_u578B_u62DF_u5408"><a href="#u6A21_u578B_u62DF_u5408" class="headerlink" title="模型拟合"></a>模型拟合</h3><p>目前选用的是逻辑回归模型，每一维度的特征对应响应的权重，这部分工作集中在线下，将训练后的权重数据以json格式写入到Mysql表中。计算公式如下：</p>
<p>$$predictCtr = \frac{1}{1+e^{\sum_1^Nweight}}$$</p>
<p>其中weight为投放的launch每一个维度所对应的权重，最后转化成概率的方式，可以将最终预估值置于［0，1］之前。由于线下训练模型时，负样本（没有点击的数据）是通过抽样的，抽样比例为0.2，所以为了还原最终的ctr预估值，还得在上式公式计算基础上乘以抽样比例。</p>
<p>模型选用的特征是可配置的，具体配置位于如上表中的Feature字段。通过2016-01-23的线上数据作模拟，统计预估的ctr比例，平均值为0.4%，接近真实的ctr值，各区间段ctr分布如下：<br><img src="http://7xqb0e.com1.z0.glb.clouddn.com/adx2_2.png" alt=""></p>
<h3 id="u6A21_u578B_u8BC4_u4F30"><a href="#u6A21_u578B_u8BC4_u4F30" class="headerlink" title="模型评估"></a>模型评估</h3><p>选用AUC(Area Under ROC Curve)曲线作为训练模型的评估标准，曲线如图所示:<br><img src="http://7xqb0e.com1.z0.glb.clouddn.com/adx2_3.png" alt=""><br>横坐标为false positive rate(FPR),纵坐标为true positive rate(TPR)。对于某个分类器而言，根据其在测试样本集上的表现得到TPR和FPR点对，那么该分类器可以映射成ROC平面上的一个点。本文模型训练的auc值为0.779。</p>
<h3 id="u7CFB_u7EDF_u5B9E_u73B0"><a href="#u7CFB_u7EDF_u5B9E_u73B0" class="headerlink" title="系统实现"></a>系统实现</h3><p>线上的主要是工程性的工作，可分为3个模块，数据收集层(ranker-collector), 模型实现层（ranker-alchemist）和投放打分层(ranker-scorer)。ranker－alchemist主要实现特征数据的获取，制作和点击率计算，对于每一维度<br>的特征，都会有与线下训练环境完全一致的离散化方法，并配置唯一的featureId。<br><img src="http://7xqb0e.com1.z0.glb.clouddn.com/ranker-alchemist.png" alt=""><br>ranker-collector主要负责原始数据的收集，数据源来自mysql，redis和Service。<br><img src="http://7xqb0e.com1.z0.glb.clouddn.com/ranker-collector.png" alt=""><br>ranker-scorer实现对投放launch打分，目前支持以下3种策略：<br><img src="http://7xqb0e.com1.z0.glb.clouddn.com/ranker-scorer.png" alt=""></p>
<h2 id="u6A21_u578B_u5BF9_u4E8ECTR_u7684_u63D0_u5347"><a href="#u6A21_u578B_u5BF9_u4E8ECTR_u7684_u63D0_u5347" class="headerlink" title="模型对于CTR的提升"></a>模型对于CTR的提升</h2><p>升级Ranker，开发线上基于的CTR计算模块，AB测试一周，与第一期排序策略对比，CTR提升16%，从0.35%-&gt;0.42%，已全流量上线。后期的工作主要是新特征的发掘和引入新的机器学习方法来优化模型，提升ctr。</p>
</div><div class="tags"><a href="/tags/ADX排序/">ADX排序</a></div><div class="post-nav"><a href="/2016/03/28/ranker3/" class="pre"><i class="icon-previous">ADX排序第三期 用户定向排序策略</i></a><a href="/2016/03/28/ranker1/" class="next">第一期历史CTR和距离排序策略<i class="icon-next"></i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title">分類</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ADX排序/">ADX排序</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">leetcode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/machine-learning/">machine learning</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/实时预算分配/">实时预算分配</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作/">工作</a></li></ul></div><div class="widget"><div class="widget-title">標籤</div><div class="tagcloud"><a href="/tags/machine-learning/" style="font-size: 15px;">machine learning</a> <a href="/tags/ADX排序/" style="font-size: 15px;">ADX排序</a> <a href="/tags/ranker/" style="font-size: 15px;">ranker</a> <a href="/tags/实时预算分配/" style="font-size: 15px;">实时预算分配</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/enum/" style="font-size: 15px;">enum</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/03/28/ranker3/">ADX排序第三期 用户定向排序策略</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/28/ranker2/">ADX排序第二期线性回归模型排序策略</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/28/ranker1/">第一期历史CTR和距离排序策略</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/28/magina-res2/">实时预算调整第二期对比实验</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/28/magina-res1/">实时预算调整第一期对比实验</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/Largest-Number/">Largest Number</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/tree/">决策树</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/17/knn/">K-近邻算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/01/enum/">策略枚举</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/26/ranker-online/">ADX 排序模块</a></li></ul></div><div class="widget"><div class="widget-title">友站連結</div><ul></ul><a href="http://www.joelonsoftware.com/" title="Joe On Software" target="_blank">Joe On Software</a></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">I See Fire.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"></div><!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body></html>